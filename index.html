<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emote Buddy</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">

    <style>
        body {
            display: flex;
            align-items: center;
            flex-direction: column;
            background-color: #0b0b16;
        }

        .container {
            top: 50%;
            left: 50%;
            position: absolute;
            margin-right: -50%;
            transform: translate(-50%, -50%);
        }


        #videoPlayer {
            margin: -25px;
        }

        .videoPlayerWrapper {
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="videoPlayerWrapper">
            <video id="videoPlayer" width="250" height="250" autoplay muted></video>
        </div>
    </div>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const videoPlayerWrapper = document.querySelector('.videoPlayerWrapper');

        // List of video files in the assets/videos folder
        const videoFiles = [
            'assets/videos/angry.mp4',
            'assets/videos/cookie.mp4',
            'assets/videos/crying.mp4',
            'assets/videos/dasai.mp4',
            'assets/videos/default.mp4',
            'assets/videos/distracted.mp4',
            'assets/videos/glitch.mp4',
            'assets/videos/headlights.mp4',
            'assets/videos/laugh.mp4',
            'assets/videos/look_down.mp4',
            'assets/videos/look_left.mp4',
            'assets/videos/look_right.mp4',
            'assets/videos/love.mp4',
            'assets/videos/music.mp4',
            'assets/videos/police.mp4',
            'assets/videos/pong.mp4',
            'assets/videos/rainbow.mp4',
            'assets/videos/raspberry.mp4',
            'assets/videos/revs.mp4',
            'assets/videos/sakura.mp4',
            'assets/videos/shrink.mp4',
            'assets/videos/sleepy.mp4',
            'assets/videos/smile.mp4',
            'assets/videos/smirk.mp4',
            'assets/videos/sneeze.mp4',
            'assets/videos/squint.mp4',
            'assets/videos/stars.mp4',
            'assets/videos/turbo.mp4',
            'assets/videos/upside_down.mp4',
            'assets/videos/uwu.mp4'
        ];

        let shuffledVideos = [];
        let currentIndex = -1;
        let wakeLock = null;
        let isReactionPlaying = false;
        let lastEventTime = 0;
        const EVENT_COOLDOWN = 1000; // 1 second debounce

        // Map events to specific reaction videos
        const eventVideoMap = {
            shake: 'assets/videos/glitch.mp4',
            tap: 'assets/videos/smile.mp4',
            swipeLeft: 'assets/videos/look_left.mp4',
            swipeRight: 'assets/videos/look_right.mp4',
            swipeUp: 'assets/videos/stars.mp4',
            swipeDown: 'assets/videos/look_down.mp4'
        };

        // Clear cache if query parameter ?clearCache=true is present
        async function clearCacheIfRequested() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('clearCache') === 'true') {
                try {
                    if ('caches' in window) {
                        const cache = await caches.open('emote-buddy-videos');
                        const keys = await cache.keys();
                        await Promise.all(keys.map(key => cache.delete(key)));
                        console.log('Cache cleared successfully');
                        // Redirect to remove query parameter
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        console.warn('Cache API not supported');
                    }
                } catch (error) {
                    console.error('Failed to clear cache:', error);
                }
            }
        }

        // Request Wake Lock to keep screen awake
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock acquired');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                } else {
                    console.warn('Wake Lock API not supported in this browser');
                }
            } catch (error) {
                console.error('Failed to acquire Wake Lock:', error);
            }
        }

        // Re-request Wake Lock on visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && wakeLock === null) {
                requestWakeLock();
            }
        });

        // Device Motion (Shake Detection)
        function setupDeviceMotion() {
            if ('DeviceMotionEvent' in window) {
                // Request permission on iOS 13+
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                addMotionListener();
                            } else {
                                console.warn('Device Motion permission denied');
                            }
                        })
                        .catch(error => console.error('Device Motion permission error:', error));
                } else {
                    addMotionListener();
                }
            } else {
                console.warn('Device Motion API not supported');
            }
        }

        function addMotionListener() {
            let lastShake = 0;
            const SHAKE_THRESHOLD = 15; // Acceleration threshold for shake
            window.addEventListener('devicemotion', event => {
                const { x, y, z } = event.accelerationIncludingGravity || {};
                if (x && y && z) {
                    const acceleration = Math.sqrt(x * x + y * y + z * z);
                    const now = Date.now();
                    if (acceleration > SHAKE_THRESHOLD && now - lastShake > EVENT_COOLDOWN) {
                        lastShake = now;
                        playReactionVideo('shake');
                    }
                }
            });
        }

        // Tap Detection
        function setupTapDetection() {
            videoPlayerWrapper.addEventListener('click', () => {
                const now = Date.now();
                if (now - lastEventTime > EVENT_COOLDOWN) {
                    lastEventTime = now;
                    playReactionVideo('tap');
                }
            });
            // Prevent double-tap zoom on mobile
            videoPlayerWrapper.addEventListener('touchstart', e => {
                e.preventDefault();
                const now = Date.now();
                if (now - lastEventTime > EVENT_COOLDOWN) {
                    lastEventTime = now;
                    playReactionVideo('tap');
                }
            }, { passive: false });
        }

        // Gesture Detection (Swipes)
        function setupGestureDetection() {
            let touchStartX = 0;
            let touchStartY = 0;
            videoPlayerWrapper.addEventListener('touchstart', e => {
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
            }, { passive: true });

            videoPlayerWrapper.addEventListener('touchend', e => {
                const touch = e.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const minSwipeDistance = 50; // Minimum swipe distance in pixels

                const now = Date.now();
                if (now - lastEventTime < EVENT_COOLDOWN) return;

                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    lastEventTime = now;
                    playReactionVideo(deltaX > 0 ? 'swipeRight' : 'swipeLeft');
                } else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > minSwipeDistance) {
                    lastEventTime = now;
                    playReactionVideo(deltaY > 0 ? 'swipeDown' : 'swipeUp');
                }
            }, { passive: true });
        }

        // Play reaction video and resume shuffle
        function playReactionVideo(eventType) {
            if (isReactionPlaying || !eventVideoMap[eventType]) return;
            isReactionPlaying = true;

            const reactionVideo = eventVideoMap[eventType];
            const originalIndex = currentIndex;

            videoPlayer.src = reactionVideo;
            videoPlayer.play();

            videoPlayer.onended = () => {
                isReactionPlaying = false;
                currentIndex = originalIndex; // Restore shuffle position
                playNextVideo();
            };

            videoPlayer.onerror = () => {
                console.error('Error playing reaction video:', reactionVideo);
                isReactionPlaying = false;
                currentIndex = originalIndex;
                playNextVideo();
            };
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/assets/scripts/sw.js', { scope: '/assets/scripts/' })
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                        clearCacheIfRequested().then(() => {
                            requestWakeLock();
                            setupDeviceMotion();
                            setupTapDetection();
                            setupGestureDetection();
                        });
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                        clearCacheIfRequested().then(() => {
                            requestWakeLock();
                            setupDeviceMotion();
                            setupTapDetection();
                            setupGestureDetection();
                        });
                    });
            });
        } else {
            window.addEventListener('load', () => {
                clearCacheIfRequested().then(() => {
                    requestWakeLock();
                    setupDeviceMotion();
                    setupTapDetection();
                    setupGestureDetection();
                });
            });
        }

        function shuffleVideos() {
            shuffledVideos = [...videoFiles];
            for (let i = shuffledVideos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledVideos[i], shuffledVideos[j]] = [shuffledVideos[j], shuffledVideos[i]];
            }
            currentIndex = -1;
            playNextVideo();
        }

        function playNextVideo() {
            if (isReactionPlaying) return;
            currentIndex = (currentIndex + 1) % shuffledVideos.length;
            videoPlayer.src = shuffledVideos[currentIndex];
            videoPlayer.play();

            videoPlayer.onended = () => {
                playNextVideo();
            };
        }

        videoPlayer.onerror = () => {
            console.error('Error playing video:', shuffledVideos[currentIndex]);
            playNextVideo();
        };

        // Start playing on load
        if (videoFiles.length > 0) {
            shuffleVideos();
        } else {
            console.error('No videos found in the assets folder.');
        }
    </script>
</body>

</html>